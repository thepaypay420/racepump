Goal: Fix race card timers/labels so the flow is
OPEN (15m betting) → LOCKED (brief) → IN_PROGRESS (15m) → SETTLED.
Right now the card shows “Settling… / Until start” forever because the countdown always targets startTs.
Update the frontend to:

When status === "OPEN": show “Betting closes in” and count down to startTs + OPEN_MS.

When status === "LOCKED": show “Going live…” and count down ~2s (lockedTs + 2000).

When status === "IN_PROGRESS": show “Settles in” and count down to lockedTs + PROGRESS_MS.

Never show “Until start” after a race has started.

Keep labels in Live & Upcoming consistent with the above.

Implementation details:

Create a helper src/helpers/raceTiming.ts:

// src/helpers/raceTiming.ts
export function getCountdownTargetAndLabel(
  race: any,
  cfg = {
    openMinutes: Number(import.meta.env.VITE_OPEN_WINDOW_MINUTES ?? 15),
    progressMinutes: Number(import.meta.env.VITE_PROGRESS_WINDOW_MINUTES ?? 15),
  }
) {
  const OPEN_MS = cfg.openMinutes * 60 * 1000;
  const PROGRESS_MS = cfg.progressMinutes * 60 * 1000;

  if (race.status === "OPEN") {
    return { target: Number(race.startTs) + OPEN_MS, label: "Betting closes in" };
  }
  if (race.status === "LOCKED") {
    return { target: Number(race.lockedTs ?? Date.now()) + 2000, label: "Going live…" };
  }
  if (race.status === "IN_PROGRESS") {
    return { target: Number(race.lockedTs ?? Date.now()) + PROGRESS_MS, label: "Settles in" };
  }
  return { target: 0, label: "" };
}


Use the helper in the race card component (usually src/components/RaceCard.tsx or similar). Replace any logic that calculates “until start” using only startTs. Make the badge text reflect the status:

// src/components/RaceCard.tsx
import { getCountdownTargetAndLabel } from "@/helpers/raceTiming";

// inside component render
const { target, label } = getCountdownTargetAndLabel(race);

<Badge variant="secondary">
  {race.status === "OPEN" && "OPEN"}
  {race.status === "LOCKED" && "LOCKED"}
  {race.status === "IN_PROGRESS" && "LIVE"}
  {race.status === "SETTLED" && "SETTLED"}
</Badge>

<Countdown target={target} prefix={label} />

// Remove/replace any UI that says "Starting Soon" or "Until start" once status is OPEN/LOCKED/IN_PROGRESS.


Make sure SSE/store updates propagate status, lockedTs, inProgressTs.
In the place you handle SSE events (race_created, race_locked, race_live/race_updated, race_settled) ensure the race object in the store is fully replaced/merged so status and timestamps are current. Example reducer/handler snippet:

// src/state/races.ts (or wherever SSE handlers live)
function upsertRace(next: any) {
  set((s) => {
    const i = s.races.findIndex((r: any) => r.id === next.id);
    if (i === -1) s.races.push(next);
    else s.races[i] = { ...s.races[i], ...next };
  });
}
// on "race_locked" -> upsertRace(payload)
// on "race_live"   -> upsertRace(payload)   // payload has status = IN_PROGRESS + inProgressTs
// on "race_updated" (bulk runner price updates) -> merge by raceId but DO NOT overwrite initialPrice/lockedTs
// on "race_settled" -> upsertRace(payload)


Expose timing values to the client (optional but recommended):
Add to .env (client):

VITE_OPEN_WINDOW_MINUTES=15
VITE_PROGRESS_WINDOW_MINUTES=15


Rebuild dev server so import.meta.env picks these up.

QA checklist (acceptance):

When a race becomes OPEN, the timer reads “Betting closes in” and counts down ~15m.

When it transitions to LOCKED, the card shows “Going live…” for ~1–2s.

When the race is IN_PROGRESS, the label becomes “Settles in” and counts down ~15m.

No card shows “Until start” once status is OPEN/LOCKED/IN_PROGRESS.

Status badge reads OPEN / LOCKED / LIVE / SETTLED consistently in Live & Upcoming.

Do not change the backend logic. This is a pure frontend fix to stop the “stuck settling / until start” confusion.